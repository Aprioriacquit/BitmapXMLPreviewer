<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitmap Font Previewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
        }
        form {
            text-align: center;
        }
        #preview-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            margin-top: 20px;
        }
        #canvas, #counterCanvas {
            border: 1px solid #ccc;
        }
        #controls, #animation-controls {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<h1>Bitmap Font Previewer</h1>

<form>
    <label for="pngFile">Upload PNG file:</label>
    <input type="file" id="pngFile" accept="image/png"><br><br>

    <label for="xmlFile">Upload XML file:</label>
    <input type="file" id="xmlFile" accept=".xml"><br><br>

    <label for="inputText">Text to render:</label>
    <input type="text" id="inputText" value="1234567890.,"><br><br>

    <label for="fontSize">Font Size (Scale):</label>
    <input type="number" id="fontSize" value="1" step="0.1" min="0.1"><br><br>

    <label for="showEdges">Show Glyph Edges:</label>
    <input type="checkbox" id="showEdges"><br><br>

    <button type="button" onclick="renderText()">Render Text</button>
</form>

<div id="preview-container">
    <canvas id="canvas" width="800" height="200"></canvas>

    <div id="animation-controls">
        <h2>Counter Animation</h2>
        <label for="from">From:</label>
        <input type="number" id="from" value="0"><br><br>

        <label for="to">To:</label>
        <input type="number" id="to" value="205632"><br><br>

        <label for="speed">Speed (ms):</label>
        <input type="number" id="speed" value="20"><br><br>

        <label for="increment">Increment:</label>
        <input type="number" id="increment" value="4"><br><br>

        <button type="button" onclick="startCounterAnimation()">Start</button>
    </div>
</div>

<canvas id="counterCanvas" width="400" height="100"></canvas>

<div id="controls">
    <h2>Adjust Glyph Parameters</h2>
    <label for="x">X:</label>
    <input type="number" id="x" onchange="updateGlyphParam('x')"><br><br>

    <label for="y">Y:</label>
    <input type="number" id="y" onchange="updateGlyphParam('y')"><br><br>

    <label for="width">Width:</label>
    <input type="number" id="width" onchange="updateGlyphParam('width')"><br><br>

    <label for="height">Height:</label>
    <input type="number" id="height" onchange="updateGlyphParam('height')"><br><br>

    <label for="xoffset">X Offset:</label>
    <input type="number" id="xoffset" onchange="updateGlyphParam('xoffset')"><br><br>

    <label for="yoffset">Y Offset:</label>
    <input type="number" id="yoffset" onchange="updateGlyphParam('yoffset')"><br><br>

    <label for="xadvance">X Advance:</label>
    <input type="number" id="xadvance" onchange="updateXAdvance()"><br><br>

    <label for="applyToAll">Apply xAdvance to All:</label>
    <input type="checkbox" id="applyToAll"><br><br>
</div>

<script>
    let image, glyphData = {};
    let selectedGlyph = null;
    let fontSize = 1;
    let animationInterval;

    document.getElementById('pngFile').addEventListener('change', loadPNG);
    document.getElementById('xmlFile').addEventListener('change', loadXML);
    document.getElementById('canvas').addEventListener('click', handleCanvasClick);
    document.getElementById('showEdges').addEventListener('change', renderText);
    document.getElementById('fontSize').addEventListener('input', () => {
        fontSize = parseFloat(document.getElementById('fontSize').value);
        renderText();
    });

    function loadPNG(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = () => {
                image = new Image();
                image.src = reader.result;
                image.onload = () => {
                    renderText(); // Render text once the image is loaded
                };
            };
            reader.readAsDataURL(file);
        }
    }

    function loadXML(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                parseXMLData(e.target.result);
            };
            reader.readAsText(file);
        }
    }

    function parseXMLData(xmlText) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "application/xml");

        xmlDoc.querySelectorAll('char').forEach(charNode => {
            const charCode = charNode.getAttribute('id');
            glyphData[charCode] = {
                x: parseInt(charNode.getAttribute('x')),
                y: parseInt(charNode.getAttribute('y')),
                width: parseInt(charNode.getAttribute('width')),
                height: parseInt(charNode.getAttribute('height')),
                xoffset: parseInt(charNode.getAttribute('xoffset')),
                yoffset: parseInt(charNode.getAttribute('yoffset')),
                xadvance: parseInt(charNode.getAttribute('xadvance')),
            };
        });
    }

    function renderText() {
        const text = document.getElementById('inputText').value;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const showEdges = document.getElementById('showEdges').checked;

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (image && glyphData) {
            let x = 30;
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i).toString();
                const glyph = glyphData[charCode];

                if (glyph) {
                    ctx.drawImage(
                        image,
                        glyph.x, glyph.y, glyph.width, glyph.height,
                        x + glyph.xoffset * fontSize,
                        30 + glyph.yoffset * fontSize,
                        glyph.width * fontSize,
                        glyph.height * fontSize
                    );

                    if (selectedGlyph === charCode) {
                        ctx.strokeStyle = "blue";
                        ctx.lineWidth = 2;
                        ctx.strokeRect(
                            x + glyph.xoffset * fontSize,
                            30 + glyph.yoffset * fontSize,
                            glyph.width * fontSize,
                            glyph.height * fontSize
                        );
                    }

                    if (showEdges) {
                        ctx.strokeStyle = "red";
                        ctx.lineWidth = 1;
                        ctx.strokeRect(
                            x,
                            30,
                            glyph.xadvance * fontSize,
                            canvas.height - 60
                        );
                    }

                    glyph.drawX = x + glyph.xoffset * fontSize;
                    glyph.drawY = 30 + glyph.yoffset * fontSize;
                    glyph.drawWidth = glyph.width * fontSize;
                    glyph.drawHeight = glyph.height * fontSize;

                    x += glyph.xadvance * fontSize;
                }
            }
        }
    }

    function handleCanvasClick(event) {
        const canvas = document.getElementById('canvas');
        const rect = canvas.getBoundingClientRect();
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;

        selectedGlyph = null;
        for (const charCode in glyphData) {
            const glyph = glyphData[charCode];
            if (x >= glyph.drawX && x <= glyph.drawX + glyph.drawWidth &&
                y >= glyph.drawY && y <= glyph.drawY + glyph.drawHeight) {
                selectedGlyph = charCode;
                document.getElementById('controls').style.display = 'block';
                document.getElementById('x').value = glyph.x;
                document.getElementById('y').value = glyph.y;
                document.getElementById('width').value = glyph.width;
                document.getElementById('height').value = glyph.height;
                document.getElementById('xoffset').value = glyph.xoffset;
                document.getElementById('yoffset').value = glyph.yoffset;
                document.getElementById('xadvance').value = glyph.xadvance;
                break;
            }
        }
        renderText();
    }

    function updateGlyphParam(param) {
        if (selectedGlyph && glyphData[selectedGlyph]) {
            glyphData[selectedGlyph][param] = parseInt(document.getElementById(param).value);
            renderText();
        }
    }

    function updateXAdvance() {
        const xadvanceValue = parseInt(document.getElementById("xadvance").value);
        const applyToAll = document.getElementById("applyToAll").checked;

        if (applyToAll) {
            const text = document.getElementById("inputText").value;
            text.split("").forEach(char => {
                const charCode = char.charCodeAt(0).toString();
                if (glyphData[charCode]) {
                    glyphData[charCode].xadvance = xadvanceValue;
                }
            });
        } else if (selectedGlyph && glyphData[selectedGlyph]) {
            glyphData[selectedGlyph].xadvance = xadvanceValue;
        }

        renderText();
    }

    function startCounterAnimation() {
        if (animationInterval) clearInterval(animationInterval);

        const from = parseInt(document.getElementById('from').value);
        const to = parseInt(document.getElementById('to').value);
        const speed = parseInt(document.getElementById('speed').value);
        const incr = parseInt(document.getElementById('increment').value);

        let counter = from;
        const increment = from < to ? incr : -incr;

        const counterCanvas = document.getElementById('counterCanvas');
        const ctx = counterCanvas.getContext('2d');

        animationInterval = setInterval(() => {
            ctx.clearRect(0, 0, counterCanvas.width, counterCanvas.height);
            renderCounter(counter.toString(), ctx, counterCanvas.width / 2);

            if (counter === to) {
                clearInterval(animationInterval);
            }
            counter += increment;
        }, speed);
    }

    function renderCounter(text, ctx, xStart) {
        let x = xStart - (text.length * 20); // Adjust for centering
        for (let i = 0; i < text.length; i++) {
            const charCode = text.charCodeAt(i).toString();
            const glyph = glyphData[charCode];

            if (glyph && image) {
                ctx.drawImage(
                    image,
                    glyph.x, glyph.y, glyph.width, glyph.height,
                    x + glyph.xoffset * fontSize,
                    10 + glyph.yoffset * fontSize,
                    glyph.width * fontSize,
                    glyph.height * fontSize
                );
                x += glyph.xadvance * fontSize;
            }
        }
    }
</script>

</body>
</html>
